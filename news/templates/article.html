{% extends 'base.html' %}

{% block meta %}
<title>Buzzar-id: {{article.title}}</title>
<script>
    let userId = parseInt(`{{user_id}}`);
    let articleId = parseInt(`{{article.id}}`);
</script>
{% if is_customer and not is_official %}
<script>
    function setSubscribeButton() {
        $.ajax({
            method: 'GET',
            url: "{% url 'news:subscribe' article.author_user.id %}",
            headers: {
                'X-CSRFToken': '{{csrf_token}}',
            },
            success: function(data) {
                if (data.subscribed) {
                    $('#subscribe_button').text('Unsubscribe');
                } else {
                    $('#subscribe_button').text('Subscribe');
                }
            },
            error: function(error) {
                alert('Error on fetching subscription data.');
            },
        });
    }
    
    function subscribe() {
        $.ajax({
            method: 'PUT',
            url: "{% url 'news:subscribe' article.author_user.id %}",
            headers: {
                'X-CSRFToken': '{{csrf_token}}',
            },
            success: function(data) {
                setSubscribeButton();
            },
            error: function(error) {
                alert('Error on updating subscription data.');
            },
        });
    }
</script>
{% endif %}
{% if is_customer %}
<script>
    function setLikeButton() {
        $.ajax({
            method: 'GET',
            url: "{% url 'news:like' article.id %}",
            headers: {
                'X-CSRFToken': '{{csrf_token}}',
            },
            success: function(data) {
                if (data.liked) {
                    $('#like_button').text('Unlike');
                } else {
                    $('#like_button').text('Like');
                }
                $('#like_count').text(data.count);
            },
            error: function(error) {
                alert('Error on fetching like data.');
            },
        });
    }
    
    function like() {
        $.ajax({
            method: 'PUT',
            url: "{% url 'news:like' article.id %}",
            headers: {
                'X-CSRFToken': '{{csrf_token}}',
            },
            success: function(data) {
                setLikeButton();
            },
            error: function(error) {
                alert('Error on updating like data.');
            },
        });
    }
</script>
{% endif %}
<script>
    function deleteArticle() {
        $.ajax({
            method: 'DELETE',
            url: "{% url 'news:article_by_id' article.id %}",
            headers: {
                'X-CSRFToken': '{{csrf_token}}',
            },
            success: function(data) {
                window.location = "{% url 'news:news_page_umkm' %}"
            },
            error: function(error) {
                alert('Error on deleting article.');
            },
        });
    }
    
    function getComments() {
        $.ajax({
            method: 'GET',
            url: "{% url 'news:article_comments' article.id %}",
            headers: {
                'X-CSRFToken': '{{csrf_token}}',
            },
            success: function(data) {
                commentList = $('#comment_list');
                commentList.empty();
                data.comments.forEach(function(comment) {
                    deleteButton = '';
                    if (userId === comment.user.id) {
                        deleteButton = `<button type="button" onclick="deleteComment(${comment.id});">Delete</button>`
                    }
                    commentList.append(`
                        <div>
                            <span>User: ${comment.user.name}</span><br/>
                            <span>${comment.body}</span>
                            ${deleteButton}
                        </div>
                    `);
                });
            },
            error: function(error) {
                alert('Error on fetching comments from server.');
            },
        });
    }
    
    function postComment() {
        commentBody = $('#comment_body').val();
        $.ajax({
            method: 'POST',
            url: "{% url 'news:article_comments' article.id %}",
            headers: {
                'X-CSRFToken': '{{csrf_token}}',
            },
            data: {
                'body': commentBody,
            },
            success: function(data) {
                getComments();
            },
            error: function(error) {
                alert('Error on posting comment to server.');
            },
        });
    }
    
    function deleteComment(commentId) {
        $.ajax({
            method: 'DELETE',
            url: `/news/api/articles/${articleId}/comments/${commentId}/`,
            headers: {
                'X-CSRFToken': '{{csrf_token}}',
            },
            success: function(data) {
                getComments();
            },
            error: function(error) {
                alert('Error on deleting comment.');
            },
        });
    }
    
    $(document).ready(function() {
        setLikeButton();
        setSubscribeButton();
        getComments();
        $('#delete_button').click(function() {
            deleteArticle();
        });
        $('#add_comment').submit(function(event) {
            event.preventDefault();
            postComment();
        });
    });
</script>
{% endblock meta %}

{% block content %}
<a href="/news/"><button type="button">Back</button></a>
<h1 id="title">{{article.title}}</h1>
<div>
    <span>Author: {{author_name}} {% if is_customer and not is_official %}<button id="subscribe_button" type="button" onclick="subscribe()">Subscribe</button>{% endif %}</span>
    <span>Created At: {{article.created_at}}</span>
    <span>Likes: <span id="like_count">{{article_likes}}</span></span>
    {% if is_customer %}<button id="like_button" type="button" onclick="like()">Like</button>{% endif %}
</div>
{% if is_author %}
    <button id="delete_button" type="button">Delete</button>
{% endif %}
<p id="body">{{article.body}}</p>
{% if is_logged_in %}
    <span>Add Comment:</span>
    <form id="add_comment">
        {% csrf_token %}
        {{comment_form.as_table}}
        <input type="submit" value="Add">
    </form>
    <span>Comments:</span>
    <div id="comment_list"></div>
{% else %}
    <span>You need to login in order to see and create comments. <a href="/login/">Login</a></span>
{% endif %}
{% endblock content %}